
-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (News)
CREATE TABLE IF NOT EXISTS news (
  id SERIAL PRIMARY KEY,
  title TEXT NOT NULL,
  date TEXT NOT NULL,
  category TEXT NOT NULL,
  description TEXT NOT NULL,
  image_url TEXT,
  video_url TEXT,
  media_urls TEXT[], 
  created_at BIGINT DEFAULT (EXTRACT(EPOCH FROM NOW()) * 1000)
);

-- 2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª (Registrations)
CREATE TABLE IF NOT EXISTS registrations (
  id SERIAL PRIMARY KEY,
  uid TEXT,
  full_name TEXT NOT NULL,
  birth_date TEXT NOT NULL,
  birth_place TEXT,
  address TEXT,
  wilaya TEXT,
  phone TEXT NOT NULL,
  facebook_link TEXT,
  education_level TEXT,
  specialization TEXT,
  has_volunteered_before TEXT,
  previous_volunteering_details TEXT,
  selected_cell TEXT,
  agrees_to_fee BOOLEAN,
  timestamp BIGINT DEFAULT (EXTRACT(EPOCH FROM NOW()) * 1000)
);

-- 3. Ø¬Ø¯ÙˆÙ„ Ù…ÙØ§ØªÙŠØ­ Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± (Idempotency Keys)
CREATE TABLE IF NOT EXISTS idempotency_keys (
  key TEXT PRIMARY KEY,
  status TEXT NOT NULL,
  created_at BIGINT,
  completed_at BIGINT
);

-- 4. Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Rate Limits - Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†)
CREATE TABLE IF NOT EXISTS rate_limits (
  uid TEXT,
  type TEXT,
  timestamp BIGINT,
  PRIMARY KEY (uid, type)
);

-- 5. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings)
CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value JSONB
);

-- Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
INSERT INTO settings (key, value) 
VALUES ('evaluation_emails', '["madmadimado59@gmail.com", "imad@gmail.com", "hafsasenoussa@gmail.com"]')
ON CONFLICT (key) DO NOTHING;

-- ==========================================
-- ğŸ›¡ï¸ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù† (Security Tables)
-- ==========================================

-- 6. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† (Admins)
CREATE TABLE IF NOT EXISTS admins (
  id SERIAL PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL, -- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø©
  salt TEXT NOT NULL, -- Ù…ÙØªØ§Ø­ ØªØ´ÙÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
  created_at BIGINT DEFAULT (EXTRACT(EPOCH FROM NOW()) * 1000)
);

-- 7. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© (Active Sessions)
CREATE TABLE IF NOT EXISTS admin_sessions (
  token TEXT PRIMARY KEY,
  admin_id INTEGER NOT NULL,
  created_at BIGINT DEFAULT (EXTRACT(EPOCH FROM NOW()) * 1000),
  expires_at BIGINT NOT NULL,
  ip_address TEXT
);

-- 8. Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø© (Brute Force Protection)
CREATE TABLE IF NOT EXISTS login_attempts (
  ip TEXT PRIMARY KEY,
  attempts INTEGER DEFAULT 1,
  last_attempt BIGINT,
  blocked_until BIGINT DEFAULT 0
);
